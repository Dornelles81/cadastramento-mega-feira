<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisar Erros de Importa√ß√£o HikCentral</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: white;
            margin: 20px 0;
        }
        .upload-area.dragover {
            background: #e8f5e9;
            border-color: #2e7d32;
        }
        input[type="file"] {
            display: none;
        }
        .btn {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background: #45a049;
        }
        .results {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        .error-summary {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .error-details {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f5f5f5;
            font-weight: bold;
        }
        .error-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .error-type.format {
            background: #fff3e0;
            color: #e65100;
        }
        .error-type.missing {
            background: #fce4ec;
            color: #c2185b;
        }
        .error-type.invalid {
            background: #e3f2fd;
            color: #1565c0;
        }
        .solution {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .solution h3 {
            margin-top: 0;
            color: #2e7d32;
        }
        .code-block {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 10px 0;
        }
        .warning {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üîç Analisador de Erros de Importa√ß√£o HikCentral</h1>
    
    <div class="upload-area" id="uploadArea">
        <p>üìÅ Arraste o arquivo de erro do HikCentral aqui ou clique para selecionar</p>
        <p style="font-size: 12px; color: #666;">Arquivo esperado: Error Details of Importing Profiles_*.xlsx</p>
        <input type="file" id="fileInput" accept=".xlsx,.xls">
        <button class="btn" onclick="document.getElementById('fileInput').click()">Selecionar Arquivo</button>
    </div>

    <div class="results" id="results">
        <h2>üìä An√°lise dos Erros</h2>
        <div id="analysisContent"></div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const results = document.getElementById('results');
        const analysisContent = document.getElementById('analysisContent');

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    analyzeErrors(workbook);
                } catch (error) {
                    alert('Erro ao ler arquivo: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function analyzeErrors(workbook) {
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            console.log('Dados do arquivo:', jsonData);
            
            // An√°lise dos erros
            const errorTypes = {};
            const errorsByField = {};
            const affectedUsers = new Set();
            
            jsonData.forEach(row => {
                // Coletar informa√ß√µes sobre o erro
                const errorMsg = row['Error Description'] || row['Descri√ß√£o do Erro'] || '';
                const userName = row['Name'] || row['Nome'] || '';
                const employeeNo = row['Employee No.'] || row['Employee ID'] || '';
                
                if (userName) affectedUsers.add(userName);
                
                // Categorizar erros
                if (errorMsg.includes('format') || errorMsg.includes('formato')) {
                    errorTypes['Formato Inv√°lido'] = (errorTypes['Formato Inv√°lido'] || 0) + 1;
                } else if (errorMsg.includes('required') || errorMsg.includes('obrigat√≥rio')) {
                    errorTypes['Campo Obrigat√≥rio'] = (errorTypes['Campo Obrigat√≥rio'] || 0) + 1;
                } else if (errorMsg.includes('duplicate') || errorMsg.includes('duplicado')) {
                    errorTypes['Duplicado'] = (errorTypes['Duplicado'] || 0) + 1;
                } else if (errorMsg.includes('Employee ID') || errorMsg.includes('Employee No')) {
                    errorTypes['ID de Funcion√°rio'] = (errorTypes['ID de Funcion√°rio'] || 0) + 1;
                } else {
                    errorTypes['Outros'] = (errorTypes['Outros'] || 0) + 1;
                }
                
                // Analisar campos problem√°ticos
                Object.keys(row).forEach(field => {
                    if (field.includes('Error') || field.includes('Erro')) return;
                    
                    const value = row[field];
                    if (!value || value === 'N/A' || value === '') {
                        errorsByField[field] = (errorsByField[field] || 0) + 1;
                    }
                });
            });
            
            // Gerar relat√≥rio
            let html = '';
            
            // Resumo
            html += `
                <div class="error-summary">
                    <h3>üìà Resumo da An√°lise</h3>
                    <p><strong>Total de erros:</strong> ${jsonData.length}</p>
                    <p><strong>Usu√°rios afetados:</strong> ${affectedUsers.size}</p>
                </div>
            `;
            
            // Tipos de erro
            html += `
                <div class="error-details">
                    <h3>üî¥ Tipos de Erro Encontrados</h3>
                    <table>
                        <tr>
                            <th>Tipo de Erro</th>
                            <th>Quantidade</th>
                            <th>Percentual</th>
                        </tr>
            `;
            
            Object.entries(errorTypes).forEach(([type, count]) => {
                const percentage = ((count / jsonData.length) * 100).toFixed(1);
                html += `
                    <tr>
                        <td>${type}</td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            });
            
            html += `</table></div>`;
            
            // Problema principal identificado
            html += `
                <div class="warning">
                    <h3>‚ö†Ô∏è Problema Principal Identificado</h3>
                    <p><strong>Employee ID/Employee No. ausente ou inv√°lido</strong></p>
                    <p>O HikCentral requer um ID de funcion√°rio √∫nico para cada pessoa. 
                    Este campo est√° ausente ou em formato incorreto na exporta√ß√£o.</p>
                </div>
            `;
            
            // Solu√ß√£o proposta
            html += `
                <div class="solution">
                    <h3>‚úÖ Solu√ß√£o Recomendada</h3>
                    <ol>
                        <li><strong>Ajustar o formato de exporta√ß√£o:</strong>
                            <ul>
                                <li>Usar o CPF (sem formata√ß√£o) como Employee ID</li>
                                <li>Garantir que todos os campos obrigat√≥rios estejam preenchidos</li>
                                <li>Remover caracteres especiais dos campos</li>
                            </ul>
                        </li>
                        <li><strong>Campos obrigat√≥rios do HikCentral:</strong>
                            <ul>
                                <li>Employee No. (ID √∫nico)</li>
                                <li>Name (Nome completo)</li>
                                <li>Gender (M/F)</li>
                                <li>Organization (Organiza√ß√£o/Departamento)</li>
                            </ul>
                        </li>
                    </ol>
                    <div class="code-block">
// Formato correto para o HikCentral:
{
    "Employee No.": "00097680095",  // CPF sem formata√ß√£o
    "Name": "Dionessa",
    "Gender": "F",
    "Organization": "MEGA-FEIRA-2025",
    "Phone": "51999775388",  // Sem formata√ß√£o
    "Email": "dornelles81@gmail.com"
}
                    </div>
                </div>
            `;
            
            // Detalhes dos erros
            html += `
                <div class="error-details">
                    <h3>üìã Detalhes dos Erros (Primeiros 10)</h3>
                    <table>
                        <tr>
                            <th>Nome</th>
                            <th>Employee ID</th>
                            <th>Descri√ß√£o do Erro</th>
                        </tr>
            `;
            
            jsonData.slice(0, 10).forEach(row => {
                html += `
                    <tr>
                        <td>${row['Name'] || row['Nome'] || 'N/A'}</td>
                        <td>${row['Employee No.'] || row['Employee ID'] || 'AUSENTE'}</td>
                        <td>${row['Error Description'] || row['Descri√ß√£o do Erro'] || ''}</td>
                    </tr>
                `;
            });
            
            html += `</table></div>`;
            
            analysisContent.innerHTML = html;
            results.style.display = 'block';
            
            // Log para debug
            console.log('Tipos de erro:', errorTypes);
            console.log('Campos problem√°ticos:', errorsByField);
            console.log('Primeira linha de erro:', jsonData[0]);
        }
    </script>
</body>
</html>