// Prisma schema for NEON database
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Participant {
  id        String   @id @default(uuid())
  name      String
  cpf       String   @unique
  email     String?
  phone     String?
  eventCode String?

  // Stand assignment
  standId   String?
  stand     Stand?   @relation(fields: [standId], references: [id])

  // Facial data stored directly in NEON
  faceImageUrl    String?  // NEON blob storage URL
  faceData        Bytes?   // Encrypted biometric template
  captureQuality  Float?   // Face detection quality score

  // Consent and compliance
  consentAccepted Boolean  @default(false)
  consentIp       String?
  consentDate     DateTime?

  // Mobile capture metadata
  deviceInfo      String?  // User agent + device details
  captureLocation String?  // Optional location data

  // Dynamic custom fields data
  customData      Json?    // Stores all custom field values as JSON

  // Document uploads
  documents       Json?    // Stores document URLs and metadata

  // Approval status
  approvalStatus       String?  @default("pending") // pending, approved, rejected
  approvedAt           DateTime? // Data da aprovação
  approvedBy           String?  // Admin que aprovou
  rejectionReason      String?  // Motivo da rejeição

  // HikCentral sync status
  hikCentralSyncStatus String?  @default("pending") // pending, syncing, synced, failed
  hikCentralPersonId   String?  // ID no sistema HikCentral
  hikCentralSyncedAt   DateTime? // Data da última sincronização
  hikCentralErrorMsg   String?  // Mensagem de erro se houver falha

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  syncLogs HikCentralSyncLog[]
  approvalLogs ApprovalLog[]

  @@index([standId])
  @@map("participants")
}

model Event {
  id          String   @id @default(uuid())
  name        String
  description String?
  eventCode   String   @unique
  startDate   DateTime
  endDate     DateTime
  maxCapacity Int      @default(2000)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@map("events")
}

// Stand Management (Booth/Kiosk registration limits)
model Stand {
  id              String   @id @default(uuid())
  name            String   // Nome do estande (ex: "Estande 1", "Samsung", "Apple")
  code            String   @unique // Código único (ex: "STAND001", "SAMSUNG")
  description     String?  // Descrição opcional

  // Registration limits
  maxRegistrations Int     @default(3) // Limite máximo de registros faciais
  currentCount     Int     @default(0) // Contador atual de registros

  // Event association
  eventCode        String? // Associar a um evento específico

  // Contact and metadata
  responsibleName  String? // Nome do responsável
  responsibleEmail String? // Email do responsável
  responsiblePhone String? // Telefone do responsável
  location         String? // Localização física do estande
  notes            Json?   // Notas adicionais em JSON

  // Status
  isActive         Boolean @default(true)

  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  participants     Participant[]

  @@index([code])
  @@index([eventCode])
  @@index([isActive])
  @@map("stands")
}

// Custom Field Management
model CustomField {
  id          String   @id @default(uuid())
  fieldName   String   @unique // Internal field name (e.g., "company", "role")
  label       String   // Display label (e.g., "Empresa", "Cargo")
  type        String   // text, number, select, date, email, tel, checkbox
  required    Boolean  @default(false)
  placeholder String?
  options     Json?    // For select/radio fields: ["Option1", "Option2"]
  validation  Json?    // Validation rules: { minLength: 3, maxLength: 100, pattern: "regex" }
  order       Int      @default(0) // Display order
  active      Boolean  @default(true)
  eventCode   String?  // Optional: field specific to an event
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("custom_fields")
}

// Event Configuration
model EventConfig {
  id              String   @id @default(uuid())
  eventName       String
  eventCode       String   @unique
  logoUrl         String?
  primaryColor    String?  // Hex color
  secondaryColor  String?  // Hex color
  requireConsent  Boolean  @default(true)
  requireFace     Boolean  @default(true)
  customMessage   String?  // Custom welcome message
  defaultFields   Json?    // Which default fields to show/hide
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("event_configs")
}

// Document Requirements Configuration
model DocumentConfig {
  id            String   @id @default(uuid())
  documentType  String   @unique // rg, cnh, cpf_doc, foto_3x4, comprovante_residencia, etc
  label         String   // "RG", "CNH", "Foto 3x4", etc
  description   String?  // Instructions for the document
  required      Boolean  @default(false)
  enableOCR     Boolean  @default(false) // Enable OCR extraction
  acceptedFormats Json?  // ["jpg", "png", "pdf"]
  maxSizeMB     Int      @default(5)
  order         Int      @default(0)
  active        Boolean  @default(true)
  eventCode     String?  // Optional: specific to an event
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("document_configs")
}

// Audit Log for tracking changes
model AuditLog {
  id            String   @id @default(uuid())
  action        String   // "CREATE", "UPDATE", "DELETE"
  entityType    String   // "participant", "event", "custom_field", etc
  entityId      String   // ID of the affected entity
  
  // User who performed the action
  adminUser     String   @default("admin") // Can be extended for multi-admin
  adminIp       String?  // IP address of admin
  
  // Change details
  previousData  Json?    // Previous state (for updates/deletes)
  newData       Json?    // New state (for creates/updates)
  changes       Json?    // Specific fields that changed
  
  // Additional context
  description   String?  // Human-readable description
  metadata      Json?    // Any additional metadata
  
  createdAt     DateTime @default(now())
  
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// Approval/Rejection Log
model ApprovalLog {
  id            String   @id @default(uuid())
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id])
  
  action        String   // "approved" or "rejected"
  previousStatus String  // Status before the action
  newStatus     String   // Status after the action
  
  reason        String?  // Reason for approval/rejection
  notes         String?  // Additional notes from admin
  
  // Admin who performed the action
  adminUser     String   @default("admin")
  adminIp       String?
  
  // Timestamps
  createdAt     DateTime @default(now())
  
  @@index([participantId])
  @@index([action])
  @@index([createdAt])
  @@map("approval_logs")
}

// HikCentral Integration Tables
model HikCentralConfig {
  id                String   @id @default(uuid())
  name              String   @default("default")
  baseUrl           String
  apiVersion        String   @default("/api/acs/v1")
  authType          String   @default("apikey") // apikey or digest
  username          String?
  password          String?  // Encrypted
  apiKey            String?  // Encrypted
  apiSecret         String?  // Encrypted
  
  // Library configuration
  libraryId         String   @default("1")
  libraryType       String   @default("blackFD")
  
  // Limits and settings
  batchSize         Int      @default(100)
  maxRetries        Int      @default(3)
  retryDelay        Int      @default(5000) // milliseconds
  requestTimeout    Int      @default(30000) // milliseconds
  rateLimit         Int      @default(10) // requests per second
  
  // Access control
  defaultAccessLevel String   @default("1")
  validityDays      Int      @default(90)
  
  // Features
  autoSync          Boolean  @default(false)
  syncInterval      Int      @default(300) // seconds
  webhookEnabled    Boolean  @default(false)
  webhookUrl        String?
  
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("hikcental_configs")
}

model HikCentralSyncLog {
  id                String   @id @default(uuid())
  participantId     String
  participant       Participant @relation(fields: [participantId], references: [id])
  
  syncType          String   // batch, individual, update, delete
  syncStatus        String   // pending, processing, success, failed
  syncDirection     String   @default("upload") // upload or download
  
  // Request/Response data
  requestData       Json?    // Request sent to HikCentral
  responseData      Json?    // Response from HikCentral
  httpStatus        Int?     // HTTP status code
  
  // HikCentral data
  hikCentralPersonId String?  // Person ID in HikCentral
  hikCentralCardNo   String?  // Card number assigned
  accessLevelIds     Json?    // Access levels assigned
  
  // Error tracking
  errorCode         String?
  errorMessage      String?
  errorDetails      Json?
  retryCount        Int      @default(0)
  
  // Timing
  startedAt         DateTime @default(now())
  completedAt       DateTime?
  duration          Int?     // milliseconds
  
  // Batch information
  batchId           String?
  batchPosition     Int?     // Position in batch
  
  createdAt         DateTime @default(now())
  
  @@index([participantId])
  @@index([syncStatus])
  @@index([batchId])
  @@index([createdAt])
  @@map("hikcental_sync_logs")
}

model HikCentralSyncBatch {
  id                String   @id @default(uuid())
  batchNumber       String   @unique // Format: BATCH-YYYYMMDD-NNNN
  
  syncType          String   // manual, scheduled, auto
  syncStatus        String   // pending, processing, completed, failed, partial
  
  totalParticipants Int      @default(0)
  successCount      Int      @default(0)
  failedCount       Int      @default(0)
  skippedCount      Int      @default(0)
  
  // Batch configuration
  configUsed        Json?    // Config snapshot at time of sync
  filterCriteria    Json?    // Filters applied for selection
  
  // Timing
  scheduledAt       DateTime?
  startedAt         DateTime?
  completedAt       DateTime?
  duration          Int?     // milliseconds
  
  // Admin tracking
  triggeredBy       String?  // admin user or system
  notes             String?  // Admin notes
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([syncStatus])
  @@index([createdAt])
  @@map("hikcental_sync_batches")
}

model HikCentralWebhookLog {
  id                String   @id @default(uuid())
  
  eventType         String   // AccessControllerEvent, FaceRecognitionEvent, etc
  eventData         Json     // Raw event data from HikCentral
  
  // Processing status
  processStatus     String   @default("pending") // pending, processed, failed, ignored
  processedAt       DateTime?
  processingError   String?
  
  // Related data
  participantId     String?  // If event relates to a participant
  hikCentralPersonId String? // Person ID from event
  
  // Request metadata
  sourceIp          String?
  headers           Json?
  signature         String?  // HMAC signature if used
  
  createdAt         DateTime @default(now())
  
  @@index([eventType])
  @@index([processStatus])
  @@index([participantId])
  @@index([createdAt])
  @@map("hikcental_webhook_logs")
}